<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>115年台語羅馬字研習營｜報名儀表板</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        morandi: {
                            bg: '#F5F5F0',
                            card: '#FFFFFF',
                            primary: '#77969A',
                            secondary: '#B1B7BA',
                            accent: '#C8A696',
                            text: '#4A5056',
                            muted: '#8C9298',
                            border: '#E0E2E5'
                        }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>
</head>
<body class="bg-morandi-bg text-morandi-text min-h-screen font-sans p-4 md:p-8">

    <!-- Header -->
    <div class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-morandi-text flex items-center gap-3">
                <i class="fa-solid fa-chart-pie text-morandi-primary"></i>
                報名現況儀表板
            </h1>
            <p class="text-morandi-muted text-sm mt-1">即時統計數據與分析</p>
        </div>
        <button onclick="fetchData()" class="bg-white border border-morandi-border px-4 py-2 rounded-lg hover:bg-gray-50 transition shadow-sm text-sm font-medium flex items-center gap-2">
            <i class="fa-solid fa-rotate-right" id="refreshIcon"></i> 重新整理
        </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-20">
        <div class="w-12 h-12 border-4 border-morandi-secondary border-t-morandi-primary rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-morandi-muted">正在讀取 Google Sheet 資料...</p>
    </div>

    <!-- Dashboard Content (Hidden initially) -->
    <div id="dashboard" class="max-w-7xl mx-auto hidden fade-in space-y-6">
        
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Card 1 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-morandi-border flex items-center justify-between">
                <div>
                    <p class="text-morandi-muted text-sm font-medium mb-1">總報名人數</p>
                    <p class="text-4xl font-bold text-morandi-primary" id="totalCount">0</p>
                </div>
                <div class="w-12 h-12 bg-morandi-bg rounded-full flex items-center justify-center text-morandi-primary text-xl">
                    <i class="fa-solid fa-users"></i>
                </div>
            </div>
            <!-- Card 2 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-morandi-border flex items-center justify-between">
                <div>
                    <p class="text-morandi-muted text-sm font-medium mb-1">今日新增</p>
                    <p class="text-4xl font-bold text-morandi-accent" id="todayCount">0</p>
                </div>
                <div class="w-12 h-12 bg-morandi-bg rounded-full flex items-center justify-center text-morandi-accent text-xl">
                    <i class="fa-solid fa-calendar-day"></i>
                </div>
            </div>
            <!-- Card 3 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-morandi-border flex items-center justify-between">
                <div>
                    <p class="text-morandi-muted text-sm font-medium mb-1">最後更新</p>
                    <p class="text-lg font-bold text-morandi-secondary" id="lastUpdate">-</p>
                </div>
                <div class="w-12 h-12 bg-morandi-bg rounded-full flex items-center justify-center text-morandi-secondary text-xl">
                    <i class="fa-regular fa-clock"></i>
                </div>
            </div>
        </div>

        <!-- Charts Section 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Job Title Chart -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-morandi-border">
                <h3 class="font-bold text-lg mb-4 border-l-4 border-morandi-primary pl-3">職稱分布</h3>
                <div class="relative h-64">
                    <canvas id="jobChart"></canvas>
                </div>
            </div>
            <!-- Level Chart -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-morandi-border">
                <h3 class="font-bold text-lg mb-4 border-l-4 border-morandi-accent pl-3">台語程度調查</h3>
                <div class="relative h-64 flex justify-center">
                    <canvas id="levelChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Motivation Chart (Full Width) -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-morandi-border">
            <h3 class="font-bold text-lg mb-4 border-l-4 border-morandi-secondary pl-3">參加動機分析 (可複選)</h3>
            <div class="relative h-64 md:h-80">
                <canvas id="motivationChart"></canvas>
            </div>
        </div>

        <!-- Recent List Table -->
        <div class="bg-white rounded-xl shadow-sm border border-morandi-border overflow-hidden">
            <div class="p-6 border-b border-morandi-border">
                <h3 class="font-bold text-lg border-l-4 border-gray-400 pl-3">最新報名紀錄 (最近 5 筆)</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-morandi-text uppercase bg-morandi-bg">
                        <tr>
                            <th class="px-6 py-3">報名時間</th>
                            <th class="px-6 py-3">姓名</th>
                            <th class="px-6 py-3">單位</th>
                            <th class="px-6 py-3">職稱</th>
                        </tr>
                    </thead>
                    <tbody id="recentTableBody">
                        <!-- JS will populate this -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // 設定您的 Google Apps Script 網址 (已更新)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw1YwMjdwwrSR_nyb6N5AsZSauJ2ThVSHM6Yi43BQuu9jQuqwMmPY-f70aLICwuV4W_/exec";

        // Chart Colors (Morandi Palette)
        const colors = [
            '#77969A', '#C8A696', '#B1B7BA', '#8C9298', '#D4D8DC', '#A6B8BC'
        ];

        let charts = {}; // Store chart instances to destroy/redraw

        document.addEventListener('DOMContentLoaded', fetchData);

        function fetchData() {
            const loading = document.getElementById('loading');
            const dashboard = document.getElementById('dashboard');
            const refreshIcon = document.getElementById('refreshIcon');

            loading.style.display = 'block';
            dashboard.classList.add('hidden');
            refreshIcon.classList.add('animate-spin');

            fetch(SCRIPT_URL)
                .then(response => response.json())
                .then(json => {
                    if (json.error) throw new Error(json.error);
                    renderDashboard(json.data);
                })
                .catch(err => {
                    console.error(err);
                    // Demo Data Fallback (if script fails or no data)
                    if(confirm("讀取資料失敗或目前無資料。是否載入「範例資料」以預覽儀表板效果？")) {
                        renderDashboard(getMockData());
                    }
                })
                .finally(() => {
                    loading.style.display = 'none';
                    dashboard.classList.remove('hidden');
                    dashboard.classList.add('fade-in');
                    refreshIcon.classList.remove('animate-spin');
                    
                    // Update Last Update Time
                    const now = new Date();
                    document.getElementById('lastUpdate').textContent = 
                        `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                });
        }

        function renderDashboard(data) {
            // 1. Update KPIs
            document.getElementById('totalCount').textContent = data.length;
            
            const todayStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            // Note: Apps Script timestamp format might need parsing, simplified check here
            const todayCount = data.filter(d => {
                const dDate = new Date(d.timestamp);
                return dDate.toISOString().split('T')[0] === todayStr;
            }).length;
            document.getElementById('todayCount').textContent = todayCount;

            // 2. Prepare Chart Data
            const jobs = {};
            const levels = {};
            const motivations = {};

            data.forEach(row => {
                // Count Jobs
                const job = row.job.split('：')[0]; // Remove details from "Other"
                jobs[job] = (jobs[job] || 0) + 1;

                // Count Levels
                levels[row.level] = (levels[row.level] || 0) + 1;

                // Count Motivations (Split by comma)
                if (row.motivation) {
                    row.motivation.split(', ').forEach(m => {
                        const cleanM = m.split('：')[0].trim();
                        motivations[cleanM] = (motivations[cleanM] || 0) + 1;
                    });
                }
            });

            // 3. Render Charts
            renderChart('jobChart', 'bar', '職稱分布', jobs);
            renderChart('levelChart', 'doughnut', '台語程度', levels);
            renderChart('motivationChart', 'bar', '參加動機', motivations, true);

            // 4. Render Table (Top 5 Recent)
            const tableBody = document.getElementById('recentTableBody');
            tableBody.innerHTML = '';
            // Sort by timestamp desc (assuming data is appended, reverse it)
            const recentData = [...data].reverse().slice(0, 5);
            
            if (recentData.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">尚無資料</td></tr>';
            } else {
                recentData.forEach(row => {
                    const date = new Date(row.timestamp);
                    const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                    
                    const tr = document.createElement('tr');
                    tr.className = "bg-white border-b hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium whitespace-nowrap">${dateStr}</td>
                        <td class="px-6 py-4">${maskName(row.name)}</td>
                        <td class="px-6 py-4">${row.dept}</td>
                        <td class="px-6 py-4"><span class="bg-morandi-bg text-morandi-primary text-xs font-medium px-2.5 py-0.5 rounded">${row.job.split('：')[0]}</span></td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
        }

        function renderChart(canvasId, type, label, dataObj, horizontal = false) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Destroy old chart if exists
            if (charts[canvasId]) charts[canvasId].destroy();

            const labels = Object.keys(dataObj);
            const values = Object.values(dataObj);

            // Config
            const config = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: '人數',
                        data: values,
                        backgroundColor: type === 'doughnut' ? colors : colors[0],
                        borderColor: type === 'doughnut' ? '#fff' : 'transparent',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: horizontal ? 'y' : 'x',
                    plugins: {
                        legend: {
                            display: type === 'doughnut',
                            position: 'right'
                        }
                    },
                    scales: type !== 'doughnut' ? {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    } : {}
                }
            };

            charts[canvasId] = new Chart(ctx, config);
        }

        // Simple Name Masking (林xx)
        function maskName(name) {
            if (!name) return '-';
            if (name.length <= 2) return name[0] + '○';
            return name[0] + '○' + name[name.length-1];
        }

        // Mock Data for Preview
        function getMockData() {
            return [
                { timestamp: new Date().toISOString(), name: "林淑雅", dept: "教學部", job: "行政人員", level: "會講但不太會講", motivation: "認識更多台語文化" },
                { timestamp: new Date().toISOString(), name: "陳大明", dept: "內科部", job: "醫師", level: "聽懂但不太會講", motivation: "提升台語口語能力, 提升對台語病患的服務品質" },
                { timestamp: new Date().toISOString(), name: "王小美", dept: "護理部", job: "醫護人員", level: "完全初學者", motivation: "學習台語書寫（羅馬字）" },
                { timestamp: new Date().toISOString(), name: "張志豪", dept: "藥劑部", job: "醫技人員", level: "會講也會寫", motivation: "認識更多台語文化, 其他" },
            ];
        }
    </script>

    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</body>
</html>
